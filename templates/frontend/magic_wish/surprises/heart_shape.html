<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>A Special Surprise for {{ wish.receiver_name }}! ‚ú®</title>
    <meta name="description" content="{{ wish.sender_name }} has sent you a magical {{ wish.wish_type }} surprise. Click to unlock the magic!">
    
    <meta property="og:title" content="A Special Surprise for {{ wish.receiver_name }}! ‚ú®">
    <meta property="og:description" content="Open the link to see a magical surprise from {{ wish.sender_name }}.">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    
    {% if wish.images.exists %}
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ wish.images.first.image.url }}">
    {% endif %}
    
    <meta property="og:type" content="website">
    <title>A Heartfull Surprise!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: radial-gradient(circle, #1a0010 0%, #050505 100%); margin: 0; overflow: hidden; touch-action: none; }
        
        /* Premium Image Styling */
        .floating-img { 
            position: absolute; border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(255, 20, 147, 0.5); 
            opacity: 0; z-index: 5; 
            border: 2px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
            backdrop-filter: blur(5px);
        }

        /* Twinkling Stars */
        .light-blink { position: absolute; background: white; border-radius: 50%; z-index: 1; filter: blur(1px); }

        .message-container { 
            z-index: 50; 
            position: relative; 
            pointer-events: none; 
            width: 85%; 
            }
        
        /* Magical Text Effect */
        .letter { 
            display: inline-block; 
            filter: none; 
            font-family: 'Georgia', serif; 
            }

        /* Heart Beat for Gift Box */
        #gift-box { 
            cursor: pointer; display: inline-block; 
            filter: drop-shadow(0 0 40px #ff1493); 
            animation: heartBeat 1.2s infinite;
        }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            15% { transform: scale(1.15); }
            30% { transform: scale(1); }
            45% { transform: scale(1.15); }
            60% { transform: scale(1); }
        }

        /* Floating Animation for Photos after reveal */
        .sway { animation: swayMove 4s ease-in-out infinite alternate; }
        @keyframes swayMove {
            from { transform: translate(0, 0) rotate(-5deg); }
            to { transform: translate(10px, 15px) rotate(5deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen text-white font-sans">

    {% if wish.selected_music or wish.custom_music %}
    <audio id="bgMusic" loop preload="auto">
        <source src="{% if wish.custom_music %}{{ wish.custom_music.url }}{% else %}{{ wish.selected_music.audio_file.url }}{% endif %}" type="audio/mpeg">
    </audio>
    {% endif %}

    <div id="lights-bg" class="fixed inset-0"></div>

    <div id="gift-container" class="text-center px-4">
        <div id="gift-box" onclick="revealSurprise()" class="text-8xl md:text-9xl mb-10">üíì</div>
        <div class="relative">
            <p class="text-2xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-600 tracking-widest uppercase mb-2">
                A Heartfull Surprise
            </p>
            <span class="text-sm md:text-lg font-light text-gray-400 italic animate-bounce block">Click to unlock the surprise ‚ú®</span>
        </div>
    </div>

    <div id="main-content" class="hidden fixed inset-0 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm z-0"></div>

        {% for img in wish.images.all %}
            <img src="{{ img.image.url }}" class="floating-img w-20 h-20 md:w-40 md:h-40" id="img-{{ forloop.counter }}">
        {% endfor %}

<div class="message-container text-center mx-auto">
    <h1 class="text-4xl md:text-7xl font-black mb-6 drop-shadow-2xl" id="wish-title">
        {% if wish.wish_type|lower == 'birthday' %}
            Happy Birthday, {{ wish.receiver_name }}!
        {% elif wish.wish_type|lower == 'anniversary' %}
            Happy Anniversary, {{ wish.receiver_name }}!
        {% elif wish.wish_type|lower == 'love' or wish.wish_type|lower == 'proposal' %}
            To the One Who Holds My Heart, {{ wish.receiver_name }} ‚ú®
        {% elif wish.wish_type|lower == 'sorry' %}
            I'm So Sorry, {{ wish.receiver_name }}
        {% elif wish.wish_type|lower == 'thank you' %}
            Thank You So Much, {{ wish.receiver_name }}!
        {% elif wish.wish_type|lower == 'miss you' %}
            Missing You A Lot, {{ wish.receiver_name }} ü•∫
        {% elif wish.wish_type|lower == 'good luck' %}
            Best of Luck, {{ wish.receiver_name }}!
        {% elif wish.wish_type|lower == 'graduation' %}
            Congrats Graduate, {{ wish.receiver_name }}!
        {% elif wish.wish_type|lower == 'festival' or wish.wish_type|lower == 'new year' %}
            Happy {{ wish.wish_type }}, {{ wish.receiver_name }}!
        {% else %}
            Special Message for {{ wish.receiver_name }}
        {% endif %}
    </h1>

    <div class="bg-transparent p-6 rounded-2xl inline-block">
        <p class="text-lg md:text-3xl lg:text-4xl font-medium italic mb-4 text-pink-100 px-4 leading-snug" id="wish-msg">
            "{{ wish.message }}"
        </p>
        <div class="flex items-center justify-center gap-2" id="sender-name">
            <span class="text-xl md:text-3xl">‚ù§Ô∏è</span>
            <p class="text-2xl md:text-5xl font-extrabold text-pink-500 uppercase tracking-tighter">
                {{ wish.sender_name }}
            </p>
        </div>
    </div>
</div>
    </div>

    <script>
        function createLights() {
            const container = document.getElementById('lights-bg');
            for (let i = 0; i < 100; i++) {
                const light = document.createElement('div');
                light.className = 'light-blink';
                const size = Math.random() * 3 + 'px';
                light.style.width = size;
                light.style.height = size;
                light.style.left = Math.random() * 100 + 'vw';
                light.style.top = Math.random() * 100 + 'vh';
                container.appendChild(light);
                gsap.to(light, { 
                    opacity: Math.random(), 
                    y: "-=20",
                    duration: 2 + Math.random() * 3, 
                    repeat: -1, 
                    yoyo: true, 
                    delay: Math.random() * 5 
                });
            }
        }

        function splitText(elementId) {
            const el = document.getElementById(elementId);
            const text = el.innerText;
            el.innerHTML = "";
            const colors = ['#ffffff', '#ff85a1', '#ff1493', '#ff758c', '#ffffff'];
            text.split("").forEach((char, i) => {
                const span = document.createElement("span");
                span.innerText = char === " " ? "\u00A0" : char;
                span.className = "letter";
                span.style.color = colors[i % colors.length];
                el.appendChild(span);
            });
        }

        function revealSurprise() {
            const music = document.getElementById('bgMusic');
            if(music) music.play().catch(e => console.log("Music play failed:", e));

            createLights();
            
            // Multiple confetti bursts for more "Magic"
            const end = Date.now() + (2 * 1000);
            (function frame() {
                confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#ff1493', '#ffffff'] });
                confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#ff1493', '#ffffff'] });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());

            gsap.to("#gift-container", { duration: 0.8, y: -100, scale: 2, opacity: 0, display: 'none', ease: "power4.in" });
            
            document.getElementById('main-content').classList.remove('hidden');
            splitText('wish-title');

            const photos = document.querySelectorAll('.floating-img');
            const total = photos.length;
            const isMobile = window.innerWidth < 768;
            const factor = isMobile ? (window.innerWidth / 30) : (window.innerWidth / 60);

            photos.forEach((photo, i) => {
                const t = (i / total) * (2 * Math.PI);
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                
                gsap.fromTo(photo, 
                    { x: 0, y: 0, scale: 0, opacity: 0, rotation: 0 },
                    { 
                        duration: 5,            
                        x: x * factor, 
                        y: y * factor, 
                        scale: 1, 
                        opacity: 1, 
                        rotation: Math.random() * 20 - 10,
                        delay: i * 0.25,          
                        ease: "power2.out",
                        onComplete: () => {
                            photo.classList.add('sway');
                            photo.style.animationDelay = `${i * 0.5}s`;
                        }
                    }
                );
            });

            gsap.from(".letter", { duration: 1, opacity: 0, scale: 0, filter: "blur(10px)", stagger: 0.03, ease: "power4.out", delay: 0.5 });
            gsap.from("#wish-msg", { duration: 1.5, opacity: 0, y: 50, delay: 1.2, ease: "power3.out" });
            gsap.from("#sender-name", { duration: 1, scale: 0, opacity: 0, delay: 2, ease: "back.out(2)" });
        }

        window.addEventListener('resize', () => {
            if (!document.getElementById('main-content').classList.contains('hidden')) {
                location.reload();
            }
        });
    </script>
</body>
</html>