<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>A Special Surprise for {{ wish.receiver_name }}! ‚ú®</title>
    <meta name="description" content="{{ wish.sender_name }} has sent you a magical {{ wish.wish_type }} surprise. Click to unlock the magic!">
    
    <meta property="og:title" content="A Special Surprise for {{ wish.receiver_name }}! ‚ú®">
    <meta property="og:description" content="Open the link to see a magical surprise from {{ wish.sender_name }}.">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    
    {% if wish.images.exists %}
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ wish.images.first.image.url }}">
    {% endif %}
    
    <meta property="og:type" content="website">
    <title>Firework Spectacular | {{ wish.receiver_name }}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Inter:wght@300;400;900&display=swap" rel="stylesheet">
    
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; font-family: 'Inter', sans-serif; 
            overflow: hidden; position: fixed;
        }
        canvas { position: absolute; inset: 0; z-index: 1; }

        .neon-title {
            font-family: 'Dancing Script', cursive;
            text-shadow: 0 0 20px rgba(255, 0, 128, 0.8), 0 0 40px rgba(121, 40, 202, 0.4);
        }

        .premium-card {
            background: transparent !important;
            backdrop-filter: none !important;
            border: none !important;
            position: relative;
            z-index: 20;
        }

        .premium-card p {
            text-shadow: 0 2px 10px rgba(0,0,0,1), 0 0 20px rgba(0,0,0,0.8);
            color: #ffffff;
        }

        @keyframes gradient-x {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .animate-gradient-x {
            background-size: 200% 200%;
            animation: gradient-x 3s linear infinite;
        }

        .portal-ring {
            position: absolute; inset: -10px;
            border: 2px solid rgba(255, 0, 128, 0.5);
            border-radius: 9999px;
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.9); opacity: 0.8; }
            100% { transform: scale(1.3); opacity: 0; }
        }

        .btn-float { animation: btn-float 3s ease-in-out infinite; }
        @keyframes btn-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        #magic-ui { 
            position: relative; z-index: 10; 
            height: 100dvh; width: 100%;
            display: flex; flex-direction: column; 
            justify-content: space-between;
            pointer-events: none;
            padding: 1.5rem 0;
        }
        .pointer-all { pointer-events: auto; }
    </style>
</head>
<body>

    {% if wish.custom_music or wish.selected_music %}
        <audio id="bgMusic" src="{% if wish.custom_music %}{{ wish.custom_music.url }}{% else %}{{ wish.selected_music.audio_file.url }}{% endif %}" loop></audio>
    {% endif %}

    <canvas id="canvas"></canvas>

    <div id="overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black transition-opacity duration-1000 px-6">
        <div class="relative btn-float">
            <div class="portal-ring"></div>
            <div class="portal-ring" style="animation-delay: 1s;"></div>
            
            <button onclick="launchShow()" class="pointer-all group relative px-10 py-5 font-black text-xl text-white uppercase tracking-[0.2em] rounded-full overflow-hidden transition-all duration-500 hover:scale-110 active:scale-95 shadow-[0_0_50px_rgba(236,72,153,0.4)]">
                <span class="absolute inset-0 bg-gradient-to-r from-rose-600 via-purple-600 to-blue-600 animate-gradient-x"></span>
                <span class="relative z-10 flex items-center gap-4">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Open Surprise üéÜ
                </span>
            </button>
        </div>
        <p class="mt-8 text-white/40 text-[9px] tracking-[0.4em] uppercase animate-pulse">Tap to ignite the magic</p>
    </div>

    <div id="magic-ui" class="hidden opacity-0 transition-opacity duration-1000">
        
        <div class="px-6 text-center">
            <p class="text-[10px] tracking-[0.6em] uppercase text-pink-500 font-bold mb-2">
                {% with w_type=wish.wish_type|lower %}
                    {% if w_type == 'birthday' %}May You Have The Best Birthday
                    {% elif w_type == 'anniversary' %}Happy Anniversary
                    {% elif w_type == 'new year' %}
                    <span class="block text-xl md:text-2xl mb-2 font-medium opacity-90 tracking-[0.2em] uppercase">
                    Welcoming <span id="year-display"></span> ‚ú®
                    </span>
                    New Chapters, New Magic! ü•Ç
                    {% elif w_type == 'proposal' %}Will You Make Me the Luckiest Person Alive üíç
                    {% elif w_type == 'graduation' %}A Monumental Milestone Achieved! Congratulations!
                    {% elif w_type == 'festival' %}Sparkling Festive Vibes ‚ú®
                    {% elif w_type == 'good luck' %}Best Of Luck 
                    {% elif w_type == 'love' %}Made For Each Other
                    {% else %}Special Wishes{% endif %}
                {% endwith %}
            </p>
            <h1 class="text-4xl md:text-7xl font-bold text-white neon-title tracking-tight">
                {{ wish.receiver_name }}
            </h1>
        </div>

        <div class="flex flex-col items-center justify-center px-4 gap-6">
            <div class="premium-card text-center max-w-2xl">
                <i class="fa-solid fa-quote-left text-2xl text-pink-500/40 mb-3 block"></i>
                <p class="text-lg md:text-3xl font-light leading-snug italic px-2">
                    "{{ wish.message }}"
                </p>
                <p class="mt-4 text-pink-400 font-black tracking-[0.3em] text-[10px] uppercase">
                    ‚Äî {{ wish.sender_name }} ‚Äî
                </p>
            </div>

            {% if wish.images.exists %}
            <div class="flex gap-3 md:gap-6 justify-center mt-2">
                {% for img_obj in wish.images.all|slice:":2" %}
                <div class="bg-white/10 p-1.5 rounded-2xl shadow-2xl backdrop-blur-md" style="transform: rotate({{ forloop.counter0|yesno:'4,-4' }}deg);">
                    <img src="{{ img_obj.image.url }}" class="w-24 h-24 sm:w-40 sm:h-40 md:w-56 md:h-56 object-cover rounded-xl">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="text-center">
            <a href="{% url 'home' %}" class="pointer-all inline-flex items-center gap-2 text-[8px] md:text-[10px] text-white/40 tracking-[0.3em] uppercase border border-white/10 px-6 py-3 rounded-full hover:bg-white/10 transition-all">
                Create Your Own Magic
            </a>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let fireworks = [];
        let particles = [];

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.velocity = { x: (Math.random() - 0.5) * 10, y: (Math.random() - 0.5) * 10 };
                this.alpha = 1; this.friction = 0.95; this.gravity = 0.12;
            }
            draw() {
                ctx.save(); ctx.globalAlpha = this.alpha; ctx.beginPath();
                ctx.arc(this.x, this.y, 1.5, 0, Math.PI * 2);
                ctx.fillStyle = this.color; ctx.shadowBlur = 8; ctx.shadowColor = this.color;
                ctx.fill(); ctx.restore();
            }
            update() {
                this.velocity.x *= this.friction; this.velocity.y *= this.friction;
                this.velocity.y += this.gravity;
                this.x += this.velocity.x; this.y += this.velocity.y;
                this.alpha -= 0.015;
            }
        }

        class Firework {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = canvas.height;
                this.targetY = Math.random() * (canvas.height * 0.4) + 60;
                this.velocity = (Math.random() * 2) + 6;
                this.color = `hsl(${Math.random() * 360}, 100%, 60%)`;
            }
            update() {
                this.y -= this.velocity;
                if (this.y <= this.targetY) {
                    for (let i = 0; i < 60; i++) particles.push(new Particle(this.x, this.y, this.color));
                    return true;
                }
                return false;
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                ctx.fillStyle = this.color; ctx.fill();
            }
        }

        function animate() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (Math.random() < 0.06) fireworks.push(new Firework());
            fireworks = fireworks.filter(f => { f.draw(); return !f.update(); });
            particles = particles.filter(p => { p.draw(); p.update(); return p.alpha > 0; });
            requestAnimationFrame(animate);
        }

        function launchShow() {
            const music = document.getElementById('bgMusic');
            if(music) music.play().catch(e => {});
            document.getElementById('overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('overlay').style.display = 'none';
                const ui = document.getElementById('magic-ui');
                ui.classList.remove('hidden');
                setTimeout(() => ui.classList.add('opacity-100'), 100);
                animate();
            }, 800);
        }

        const year = new Date().getFullYear();
            if(document.getElementById('year-display')) {
                document.getElementById('year-display').textContent = year;
        }
    </script>
</body>
</html>