<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>A Special Surprise for {{ wish.receiver_name }}! âœ¨</title>
    <meta name="description" content="{{ wish.sender_name }} has sent you a magical {{ wish.wish_type }} surprise. Click to unlock the magic!">
    
    <meta property="og:title" content="A Special Surprise for {{ wish.receiver_name }}! âœ¨">
    <meta property="og:description" content="Open the link to see a magical surprise from {{ wish.sender_name }}.">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    
    {% if wish.images.exists %}
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ wish.images.first.image.url }}">
    {% endif %}
    
    <meta property="og:type" content="website">
    <title>Deep Sea | {{ wish.receiver_name }}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;600&family=Playfair+Display:italic,wght@700&family=Montserrat:wght@200;400&display=swap" rel="stylesheet">
    
    <style>
        :root { --deep-blue: #001219; --mid-blue: #005f73; --ocean-cyan: #94d2bd; }
        body, html { 
            margin: 0; padding: 0; background: var(--deep-blue); 
            color: white; overflow: hidden;
            font-family: 'Comfortaa', sans-serif; height: 100vh; width: 100vw;
        }
        .ocean-floor { position: fixed; inset: 0; background: linear-gradient(to bottom, #005f73 0%, #001219 100%); z-index: -1; }
        .water-surface { position: fixed; inset: 0; background: url('https://www.transparenttextures.com/patterns/water.png'); opacity: 0.1; pointer-events: none; z-index: 1; animation: moveWater 30s linear infinite; }
        @keyframes moveWater { from { background-position: 0 0; } to { background-position: 500px 500px; } }
        #bubble-canvas { position: fixed; inset: 0; z-index: 5; pointer-events: none; }
        .jelly-card { 
            background: rgba(148, 210, 189, 0.07); 
            backdrop-filter: blur(20px); 
            border-radius: 50% 50% 45% 45% / 35% 35% 65% 65%; 
            border: 1px solid rgba(148, 210, 189, 0.25); 
            box-shadow: 0 0 60px rgba(0,0,0,0.4); 
            padding: 2.5rem 2rem; width: 88%; max-width: 450px;
            text-align: center; z-index: 100; position: relative;
        }
        .ocean-title { font-family: 'Playfair Display', serif; color: var(--ocean-cyan); font-size: clamp(1.4rem, 6vw, 2.3rem); text-shadow: 0 0 20px rgba(148, 210, 189, 0.4); }
        #message-text { font-family: 'Montserrat', sans-serif; font-weight: 300; color: #e9d8a6; font-size: clamp(0.9rem, 4vw, 1.15rem); line-height: 1.6; }
        .sea-frame { position: absolute; width: clamp(80px, 20vw, 120px); height: clamp(80px, 20vw, 120px); border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; overflow: hidden; border: 2px solid rgba(148, 210, 189, 0.3); box-shadow: 0 0 25px rgba(0,0,0,0.5); opacity: 0; z-index: 10; pointer-events: none; will-change: transform; }
        .sea-frame img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.8) contrast(1.1); }
        .btn-dive { background: transparent; border: 2px solid var(--ocean-cyan); color: var(--ocean-cyan); padding: 0.9rem 2.8rem; border-radius: 50px; font-weight: bold; letter-spacing: 5px; }
        .blast-text { background: linear-gradient(to right, #94d2bd, #e9d8a6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>

<audio id="bg-music" loop>
    {% if wish.custom_music or wish.selected_music %}
        <source src="{% if wish.custom_music %}{{ wish.custom_music.url }}{% else %}{{ wish.selected_music.audio_file.url }}{% endif %}" type="audio/mpeg">
    {% endif %}
</audio>

<div class="ocean-floor"></div>
<div class="water-surface"></div>
<canvas id="bubble-canvas"></canvas>

<div id="overlay" class="fixed inset-0 z-[500] flex items-center justify-center bg-[#001219]">
    <div class="text-center">
        <div class="mb-6 text-5xl animate-bounce">ðŸ«§</div>
        <button id="diveBtn" class="btn-dive uppercase">Dive In</button>
    </div>
</div>

<div id="floating-assets" class="fixed inset-0 pointer-events-none overflow-hidden">
    {% for img_obj in wish.images.all %}
    <div class="sea-frame">
        <img src="{{ img_obj.image.url }}">
    </div>
    {% endfor %}
</div>

<main id="scene" class="hidden h-screen w-screen flex flex-col items-center justify-center overflow-hidden px-4">
    <div class="jelly-card">
        <div class="mb-3 text-[9px] tracking-[0.6em] text-cyan-400/60 uppercase font-bold">
            {% if wish.wish_type|lower == 'sorry' %} From the depths {% else %} A Submerged Gift {% endif %}
        </div>
        <h1 class="ocean-title mb-4">
            {% if wish.wish_type|lower == 'sorry' %} Hope You Can Forgive Me, {{ wish.receiver_name|upper }}
            {% elif wish.wish_type|lower == 'love' %} MY OCEAN, {{ wish.receiver_name|upper }}
            {% else %} FOR {{ wish.receiver_name|upper }} {% endif %}
        </h1>
        <p id="message-text" class="italic"></p>
        <div class="mt-8 flex flex-col items-center opacity-40">
            <div class="w-10 h-[1px] bg-cyan-500 mb-2"></div>
            <p class="text-[9px] tracking-[0.5em] font-bold text-cyan-300 uppercase">{{ wish.sender_name }}</p>
        </div>
    </div>
    <footer class="absolute bottom-6 w-full flex justify-center opacity-50 z-[110]">
        <a href="{% url 'home' %}" class="flex flex-col items-center gap-1 group pointer-events-auto">
            <span class="text-[7px] tracking-[0.4em] uppercase text-cyan-600">Deep Sea by</span>
            <span class="text-[10px] font-black tracking-[0.2em] blast-text">SURPRISE ME</span>
        </a>
    </footer>
</main>

<script>
    const canvas = document.getElementById('bubble-canvas');
    const ctx = canvas.getContext('2d');
    let bubbles = [];

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    class Bubble {
        constructor() { this.reset(); this.y = Math.random() * canvas.height; }
        reset() { this.x = Math.random() * canvas.width; this.y = canvas.height + 20; this.size = Math.random() * 3 + 1; this.speed = Math.random() * 0.7 + 0.3; this.opacity = Math.random() * 0.3; }
        draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = `rgba(148, 210, 189, ${this.opacity})`; ctx.fill(); }
        update() { this.y -= this.speed; if (this.y < -20) this.reset(); }
    }

    document.getElementById('diveBtn').addEventListener('click', () => {
        // MUSIC PLAY LOGIC
        const music = document.getElementById('bg-music');
        if (music) {
            music.volume = 0;
            music.play().catch(e => console.log("Audio Blocked", e));
            gsap.to(music, { volume: 0.5, duration: 4 });
        }

        // OVERLAY FADE OUT
        gsap.to("#overlay", { opacity: 0, duration: 1.2, onComplete: () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('scene').classList.remove('hidden');
            document.getElementById('message-text').innerText = "{{ wish.message|escapejs }}";

            // CARD ANIMATION
            gsap.from(".jelly-card", { y: 50, opacity: 0, duration: 1.5, ease: "power3.out" });

            // PHOTO FRAMES ANIMATION
            const frames = document.querySelectorAll('.sea-frame');
            frames.forEach((f, i) => {
                const startX = Math.random() * window.innerWidth;
                const startY = Math.random() * window.innerHeight;
                gsap.set(f, { x: startX, y: startY, opacity: 0, scale: 0.5 + Math.random() * 0.5 });
                gsap.to(f, { opacity: 0.5, duration: 2, delay: i * 0.2 });

                function wander() {
                    gsap.to(f, {
                        x: Math.random() * (window.innerWidth - 100),
                        y: Math.random() * (window.innerHeight - 100),
                        rotation: Math.random() * 360,
                        duration: 10 + Math.random() * 15,
                        ease: "sine.inOut",
                        onComplete: wander
                    });
                }
                wander();
            });

            // BUBBLES START
            for (let i = 0; i < 40; i++) bubbles.push(new Bubble());
            function animate() { 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                bubbles.forEach(b => { b.update(); b.draw(); }); 
                requestAnimationFrame(animate); 
            }
            animate();
        }});
    });

    // PARALLAX EFFECT
    document.addEventListener('mousemove', (e) => {
        const x = (window.innerWidth / 2 - e.pageX) / 45;
        const y = (window.innerHeight / 2 - e.pageY) / 45;
        gsap.to(".jelly-card", { x: x, y: y, duration: 2 });
    });
</script>
</body>
</html>