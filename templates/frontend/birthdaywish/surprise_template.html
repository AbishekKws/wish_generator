{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday {{ wish.receiver_name }}!</title>
    {% block extra_head %}
    <meta property="og:title" content="A Special Magical Surprise for {{ wish.receiver_name }}! ‚ú®">
    <meta property="og:description" content="Open this link to see a magical surprise created by {{ wish.sender_name }} just for you. Memories, Music, and Magic inside!">

    {% if images.first %}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ images.first.image.url }}">
    {% else %}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'images/default_surprise_thumb.jpg' %}">
    {% endif %}

    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Magical Surprise for {{ wish.receiver_name }}">
    <meta name="twitter:description" content="Created by {{ wish.sender_name }} with love.">
    {% endblock %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-pink: #ff8fa3;
            --dark-pink: #ff4d6d;
            --bg-light: #ffdee5;
            --dark-night: #0a0a12;
        }

        body, html {
            margin: 0; padding: 0; min-height: 100%;
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            background-color: var(--bg-light);
            transition: background 1.5s ease;
        }

        body.lights-on { background-color: var(--dark-night); }

        .step-container {
            display: none; min-height: 100vh; width: 100%;
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px; position: relative;
        }
        .active { display: flex; }

        /* Step 2 Special Card Style */
        .magic-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px;
            max-width: 450px;
            border: 2px solid var(--primary-pink);
            box-shadow: 0 20px 40px rgba(255, 143, 163, 0.3);
            position: relative;
            overflow: hidden;
            animation: floatCard 3s ease-in-out infinite;
        }

        .floating-icon {
            position: absolute;
            font-size: 1.5rem;
            opacity: 0.6;
            animation: pulseIcon 2s infinite alternate;
        }

        @keyframes floatCard {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        @keyframes pulseIcon {
            from { transform: scale(1); opacity: 0.4; }
            to { transform: scale(1.3); opacity: 1; }
        }
        /* Step 2 Special Card Style ends */

        /* --- LIGHTS STYLES --- */
        /* 1. Real Hanging Lights Effect */
        .hanging-light {
            position: absolute;
            top: -10px;
            width: 2px;
            height: 80px;
            background: rgba(255, 255, 255, 0.3);
            transform-origin: top;
            animation: swing 2s infinite ease-in-out;
        }

        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            animation: explode 0.6s ease-out forwards;
            pointer-events: none;
            z-index: 100;
        }

        .hanging-light::after {
            content: '';
            position: absolute;
            bottom: 0; 
            left: -5px;
            width: 12px; 
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 15px currentColor;
            background: currentColor;
        }

        /* 2. Floating Balloons */
        .balloon {
            position: absolute;
            bottom: -100px;
            width: 40px; 
            height: 50px;
            border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
            animation: floatUp 6s linear forwards;
        }

        /* 3. Banner & Cake Positioning */
        .bday-banner {
            position: absolute;
            top: 20%;
            width: 100%;
            text-align: center;
            font-family: 'Pacifico', cursive;
            font-size: 2.3rem;
            color: #fff;
            text-shadow: 0 0 15px #ff4d6d, 0 0 25px #ff8fa3;
            animation: dropIn 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            z-index: 10;
            margin-bottom: 20px !important;
            padding-bottom: 20px;
        }

        #status-element-id { 
            margin-top: 50px;
            font-size: 1.5rem;
            display: block;
        }

        .bday-cake {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 6rem;
            filter: drop-shadow(0 0 20px rgba(255, 214, 10, 0.5));
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            z-index: 10;
        }

        /* --- ANIMATIONS KEYFRAMES --- */
        @keyframes swing {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        @keyframes floatUp {
            to { transform: translateY(-120vh) rotate(20deg); opacity: 0; }
        }

        @keyframes dropIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes popIn {
            from { transform: translateX(-50%) scale(0); }
            to { transform: translateX(-50%) scale(1); }
        }

        @keyframes explode {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(25); opacity: 0; box-shadow: 0 0 40px 20px currentColor; }
        }
        /* --- END LIGHTS STYLES --- */

        /* --- HEART BOX STYLE --- */
        .heart-wrapper {
            position: relative; 
            width: 280px; 
            height: 250px;
            margin: 40px auto; 
            cursor: pointer;
            perspective: 1000px; /* 3D look ko lagi */
        }

        .heart-main {
            font-size: 220px; 
            color: #e6002a;
            filter: drop-shadow(0 0 15px rgba(255, 77, 109, 0.4));
        }

        .heart-door {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 6;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .door-left {
            clip-path: inset(0 49.5% 0 0);
        }

        .door-right {
            clip-path: inset(0 0 0 49.5%); 
        }

        .open .door-left {
            transform: translateX(-100px) rotateY(-45deg);
            opacity: 0;
        }

        .open .door-right {
            transform: translateX(100px) rotateY(45deg);
            opacity: 0;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 576px) {
            .heart-main {
                font-size: 180px;
            }
            .heart-wrapper {
                width: 220px;
                height: 200px;
            }
            .msg-inside {
                width: 85%; 
                max-height: 300px;
            }
        }

        /* Message Box with Scrolling Capability */
        .msg-inside {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) scale(0.5); 
            opacity: 0; 
            
            /* Size Constraints */
            width: 300px; 
            max-height: 350px; 
            background: #ffffff;
            
            padding: 25px;
            border-radius: 20px;
            border: 4px solid #ffccd5;
            z-index: 1;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            
            /* Scroll Logic */
            overflow-y: auto; 
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            
            transition: 0.8s 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }

        .open .msg-inside { 
            opacity: 1; 
            transform: translate(-50%, -50%) scale(1); 
        }

        /* Scrollbar ko track (background) */
        .msg-inside::-webkit-scrollbar {
            width: 6px;
        }

        /* Scrollbar ko handle */
        .msg-inside::-webkit-scrollbar-thumb {
            background: #ff4d6d; 
            border-radius: 10px;
        }

        /* Scrollbar ko handle hover garda */
        .msg-inside::-webkit-scrollbar-thumb:hover {
            background: #ff758f;
        }

        /* Scrollbar ko track */
        .msg-inside::-webkit-scrollbar-track {
            background: #fff0f3;
            border-radius: 10px;
        }

        /* Message Text Styling */
        .msg-content p {
            color: #444;
            line-height: 1.6;
            font-size: 1.05rem;
            text-align: left; 
            margin-bottom: 15px;
            white-space: pre-line;
        }
        
        @keyframes dhukDhuk {
            0% { transform: scale(1); }
            15% { transform: scale(1.1); }
            30% { transform: scale(1); }
            45% { transform: scale(1.15); } 
            100% { transform: scale(1); }
        }

        .heart-wrapper {
            position: relative; 
            width: 280px; 
            height: 250px;
            margin: 40px auto; 
            cursor: pointer;
            perspective: 1000px;
            animation: dhukDhuk 1.2s infinite ease-in-out;
            transition: all 0.5s ease;
        }

        .heart-wrapper.open {
            animation: none; 
        }
        /* --- HEART BOX STYLE ENDS--- */

        /* --- PHOTO GRID --- */
        .memory-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px; width: 100%; max-width: 800px;
        }
        .memory-card img {
            width: 100%; height: 160px; object-fit: cover;
            border-radius: 12px; border: 4px solid white;
        }
        /* --- PHOTO GRID ENDS --- */

        /* --- BUTTONS --- */
        .btn-custom {
            background: var(--dark-pink); color: white; border: none;
            padding: 14px 40px; border-radius: 50px; font-weight: 600;
            transition: 0.3s; margin-top: 20px; z-index: 20;
            box-shadow: 0 10px 20px rgba(255, 77, 109, 0.3);
        }
        .btn-custom:active { transform: scale(0.95); }

        @keyframes glow {
            from { box-shadow: 0 0 5px #fff; opacity: 0.6; }
            to { box-shadow: 0 0 15px #ff0; opacity: 1; }
        }


        .bg-pitch-black {
            background-color: #000 !important;
            transition: background-color 1.5s ease;
        }
    </style>
</head>
<body>

    {% comment %} --- BACKGROUND MUSIC ---  {% endcomment %}
    {% if wish.music %}
    <audio id="bgMusic" loop>
        <source src="{{ wish.music.url }}" type="audio/mpeg">
    </audio>
    {% endif %}

    <div class="light-strand" id="globalLights"></div>

    {% comment %} --- STEP 01 WISH ---  {% endcomment %}
    <div id="step1" class="step-container active">
        <div class="animate__animated animate__fadeIn">
            <div class="text-7xl mb-6 animate-bounce">üéÅ</div>
            
            <h1 style="font-family: 'Pacifico', cursive; color: var(--dark-pink); font-size: 3rem; line-height: 1.2;">
                Hey {{ wish.receiver_name }}, <br>
                <span style="font-size: 2rem; color: #666; font-family: 'Poppins';">{{ wish.sender_name }} has sent you a secret...</span>
            </h1>
            
            <p class="mt-4 text-gray-500 italic">
                "It‚Äôs not just a link, it‚Äôs a box full of memories and magic."
            </p>

            <button class="btn-custom mt-5 px-5" onclick="goToStep(2)">
                Unlock the Secret üîì
            </button>
        </div>
    </div>

    {% comment %} --- STEP 02 WISH ---  {% endcomment %}
    <div id="step2" class="step-container">
        <div class="magic-card text-center">
            <div class="floating-icon" style="top: 10%; left: 10%;">‚ú®</div>
            <div class="floating-icon" style="bottom: 15%; right: 10%;">üíñ</div>
            <div class="floating-icon" style="top: 20%; right: 15%;">‚≠ê</div>
            
            <div class="mb-4">
                <i class="fas fa-gift fa-3x" style="color: var(--dark-pink); animation: swing 2s infinite;"></i>
            </div>
            
            <h2 class="mb-4" style="font-family: 'Pacifico', cursive; color: #333;">
                Wait a second, <span style="color: var(--dark-pink);">{{ wish.receiver_name }}</span>...
            </h2>
            
            <div style="background: var(--bg-light); padding: 15px; border-radius: 15px; margin-bottom: 25px;">
                <p class="mb-0" style="font-weight: 500; color: #555;">
                    "I have been eagerly waiting for this special day for so long, and finally, the moment is here to celebrate you."
                </p>
            </div>
            
            <p class="text-muted small mb-4">Are you ready to see the magic unfold?</p>
            
            <button class="btn-custom w-100" onclick="goToStep(3)">
                Yes, Start the Magic! üöÄ
            </button>
        </div>
    </div>

    {% comment %} --- STEP 03 LIGHTING EFFECTS ---  {% endcomment %}
    <div id="step3" class="step-container">
        <h2 id="lightStatusText" class="mb-4" style="color: var(--dark-pink);">The room is too dark...</h2>
        <div id="visualAdditions" class="mb-4"></div>
        <button id="mainLightBtn" class="btn-custom" style="background: #ffd60a; color: #000;" onclick="evolveLights()">
            üí° Turn On the Lights
        </button>
    </div>

    {% comment %} --- STEP 04 MESSAGE FROM HEART ---  {% endcomment %}
    <div id="step4" class="step-container text-center">
        <h2 class="mb-5 text-warning">üíñ A Message From My Heart</h2>
        
        <div class="heart-wrapper mx-auto" id="heartBox" onclick="openHeart()">
            <div class="heart-door door-left">
                <i class="fas fa-heart heart-main"></i>
            </div>
            
            <div class="heart-door door-right">
                <i class="fas fa-heart heart-main"></i>
            </div>
            
            <div class="msg-inside shadow-lg">
                <div class="msg-content">
                    <p>{{ wish.message }}</p>
                    <h5 class="mt-3 text-danger">- {{ wish.sender_name }}</h5>
                </div>
            </div>
        </div>

        <p id="heartHint" class="mt-5 text-white-50">Tap the heart to reveal the secret</p>
        
        <div class="mt-5">
            <button id="memoryBtn" class="btn btn-lg btn-danger rounded-pill px-4" style="display:none;" onclick="goToStep(5)">
                View Our Memories üì∏
            </button>
        </div>
    </div>

    {% comment %} --- STEP 05 MEMORIES ---  {% endcomment %}
    <div id="step5" class="step-container">
        <h3 class="mb-4 text-white">
        <i class="fas fa-camera-retro camera-icon"></i> 
                Our Beautiful Memories 
        <i class="fas fa-images camera-icon"></i>
        </h3>
        <div class="memory-grid px-3">
            {% for item in images %}
            <div class="memory-card">
                <img src="{{ item.image.url }}" alt="Memory">
            </div>
            {% endfor %}
        </div>
        <h3 class="mt-5" style="font-family: 'Pacifico'; color: #ffffff; font-size: 2rem;">
            Forever Yours ‚Äî {{ wish.sender_name }} ‚ù§Ô∏è
        </h3>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        let lightPhase = 0;
        const music = document.getElementById('bgMusic');

        function goToStep(num) {
            document.querySelectorAll('.step-container').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + num).classList.add('active');
            
            if (num === 3) {
                document.body.style.backgroundColor = "#000";
                document.body.classList.remove('lights-on');
            }
            if(num === 4) {
                document.body.style.transition = "background 20s ease";
                document.body.style.backgroundColor = "#ff8fa3";
                document.getElementById('globalLights').innerHTML = '';
                document.body.classList.add('lights-on');
            }
        }

        function evolveLights() {
            lightPhase++;
            const btn = document.getElementById('mainLightBtn');
            const status = document.getElementById('lightStatusText');
            const container = document.getElementById('globalLights');
            const isMobile = window.innerWidth <= 768;

            // --- FIREWORKS HELPER (Padkine Effect) ---
            const createFirework = () => {
                const f = document.createElement('div');
                f.className = 'firework';
                f.style.left = Math.random() * 100 + 'vw';
                f.style.top = Math.random() * 100 + 'vh';
                const colors = ['#ff0055', '#00fbff', '#ffea00', '#ff00ff', '#00ff00'];
                f.style.color = colors[Math.floor(Math.random() * colors.length)];
                container.appendChild(f);
                setTimeout(() => f.remove(), 600); 
            };

            if (lightPhase === 1) {
                // STEP 1: Hanging Lights & Fireworks
                document.body.style.backgroundColor = ""; 
                document.body.classList.add('lights-on');
                container.style.display = 'block';
                
                for(let i=0; i<25; i++) {
                    const l = document.createElement('div');
                    l.className = 'hanging-light';
                    l.style.left = (i * 4.2) + 'vw';
                    l.style.height = (Math.random() * 80 + 40) + 'px';
                    const colors = ['#ffd60a', '#00fabb', '#f700ff','#2700b4', '#0ff80f', '#ff0505', '#ffffff', '#70e000'];
                    l.style.color = colors[i % colors.length];
                    l.style.animationDelay = (Math.random() * 2) + 's';
                    container.appendChild(l);
                }

                // Chuii Chuii Padkine logic
                let fireworkCount = 0;
                const fireworkInterval = setInterval(() => {
                    createFirework();
                    fireworkCount++;
                    if(fireworkCount > 15) clearInterval(fireworkInterval);
                }, 300);

                status.innerText = "The world glows brighter with you... ‚ú®";
                btn.innerText = "Make it more special üö©";
                if(music) music.play();
            } 
            else if (lightPhase === 2) {
                // STEP 2: Birthday Banner
                const banner = document.createElement('div');
                banner.className = 'bday-banner';
                banner.innerHTML = "HAPPY BIRTHDAY";
                
                // Mobile ra Laptop spacing adjustment
                banner.style.marginBottom = isMobile ? "80px" : "50px"; 
                container.appendChild(banner);

                status.innerText = "You deserve a grand celebration! üéä";
                status.style.marginTop = isMobile ? "30px" : "40px";
                btn.innerText = "Add more colors üéà";
            }
            else if (lightPhase === 3) {
                // STEP 3: Floating Balloons
                for(let i=0; i<15; i++) {
                    setTimeout(() => {
                        const b = document.createElement('div');
                        b.className = 'balloon';
                        b.style.left = Math.random() * 90 + 'vw';
                        const colors = ['#ff8fa3', '#ff4d6d', '#ffd60a', '#3a86ff'];
                        b.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        b.style.boxShadow = `inset -5px -5px 10px rgba(0,0,0,0.2), 0 0 15px ${b.style.backgroundColor}`;
                        container.appendChild(b);
                    }, i * 200);
                }
                status.innerText = "Sending all my love into the air! üéà‚ù§Ô∏è";
                btn.innerText = "Let's Bring the Cake üéÇ";
            }
            else if (lightPhase === 4) {
                // STEP 4: The Cake Appearance
                const cake = document.createElement('div');
                cake.className = 'bday-cake';
                cake.innerHTML = "üéÇ";
                container.appendChild(cake);

                status.innerText = "Sweetness for the sweetest person! üéÇ‚ú®";
                btn.innerText = "Unlock my heart üåü";
            }
            else {
                // STEP 5: Final Confetti
                confetti({ 
                    particleCount: 200, 
                    spread: 100, 
                    origin: { y: 0.6 },
                    colors: ['#ff8fa3', '#ff4d6d', '#ffd60a', '#ffffff']
                });
                
                status.innerText = "You are my favorite surprise! ‚ù§Ô∏è";
                btn.innerText = "Read My Secret Message üíå";
                
                btn.onclick = () => {
                    if(music) {
                        music.pause();
                        music.currentTime = 0; 
                    }
                    goToStep(4);
                };
            }
        }

        function createLights(type) {
            const container = document.getElementById('globalLights');
            const count = type === 'fairy' ? 30 : 20; 
            
            for (let i = 0; i < count; i++) {
                const bulb = document.createElement('div');
                bulb.className = 'bulb';
                bulb.style.left = Math.random() * 100 + 'vw';
                bulb.style.top = Math.random() * 100 + 'vh';
                
                // Random colors for bulbs
                const colors = ['#ff0', '#f0f', '#0ff', '#fff', '#f00', '#0f0'];
                bulb.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                bulb.style.animationDelay = Math.random() * 2 + 's';
                bulb.style.boxShadow = `0 0 15px ${bulb.style.backgroundColor}`;
                
                if(type === 'balloons') {
                    bulb.style.width = '20px';
                    bulb.style.height = '25px';
                    bulb.style.borderRadius = '50% 50% 50% 50% / 40% 40% 60% 60%';
                }
                
                container.appendChild(bulb);
            }
        }

        function openHeart() {
            const heartBox = document.getElementById('heartBox');
            if(!heartBox.classList.contains('open')) {
                heartBox.classList.add('open');
                document.getElementById('heartHint').style.display = 'none';
                
                // Celebrate message opening
                confetti({ 
                    particleCount: 100, 
                    spread: 70, 
                    origin: { y: 0.6 },
                    colors: ['#ff4d6d', '#ffffff']
                });

                setTimeout(() => {
                    document.getElementById('memoryBtn').style.display = 'inline-block';
                    // Scroll down to the button on mobile
                    document.getElementById('memoryBtn').scrollIntoView({ behavior: 'smooth' });
                }, 2000);
            }
        }
    </script>
</body>
</html>