{% extends 'backend/base.html' %}

{% block content %}
<div class="container-fluid py-3">
    <div class="mb-4">
        <h3 class="fw-bold text-dark mb-1"> Quick Wish</h3>
        <p class="text-muted small">Monitor and manage all wishes with full visibility.</p>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <form method="GET" class="row g-2 align-items-end">
                <div class="col-12 col-md-5">
                    <label class="form-label small fw-bold text-secondary">Search</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                        <input type="text" name="q" class="form-control border-start-0 ps-0" placeholder="Sender or Receiver..." value="{{ query }}">
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4">
                    <label class="form-label small fw-bold text-secondary">Wish Type</label>
                    <select name="type" class="form-select">
                        <option value="">All Wish Types</option>
                        {% for t in types %}
                        <option value="{{ t }}" {% if wish_type == t %}selected{% endif %}>{{ t|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 py-3 text-uppercase small fw-bold text-secondary border-0">Sender</th>
                            <th class="py-3 text-uppercase small fw-bold text-secondary border-0">Receiver</th>
                            <th class="py-3 text-uppercase small fw-bold text-secondary border-0">Type</th>
                            <th class="py-3 text-uppercase small fw-bold text-secondary border-0">Created At</th>
                            <th class="py-3 text-uppercase small fw-bold text-secondary border-0 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for wish in wishes %}
                        <tr>
                            <td class="ps-4 py-3 fw-bold text-dark">{{ wish.sender_name }}</td>
                            <td class="py-3 text-secondary">{{ wish.receiver_name }}</td>
                            <td class="py-3">
                                <span class="badge rounded-pill bg-primary-subtle text-primary border border-primary-subtle px-3">
                                    {{ wish.wish_type|title }}
                                </span>
                            </td>
                            <td class="py-3 small text-muted">
                                {{ wish.created_at|date:"M d, Y" }} <br>
                                <span style="font-size: 0.7rem;">{{ wish.created_at|date:"H:i" }}</span>
                            </td>
                            <td class="py-3 text-center">
                                <button class="btn btn-sm btn-outline-danger border-0 rounded-circle" 
                                        onclick="confirmDeleteWish('{{ wish.id }}', '{{ wish.sender_name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="d-md-none">
                {% for wish in wishes %}
                <div class="p-3 border-bottom position-relative">
                    <div class="row g-0">
                        <div class="col-9">
                            <div class="small text-uppercase fw-bold text-muted mb-1" style="font-size: 0.65rem;">Sender</div>
                            <div class="fw-bold text-dark mb-2">{{ wish.sender_name }}</div>
                            
                            <div class="small text-uppercase fw-bold text-muted mb-1" style="font-size: 0.65rem;">Receiver</div>
                            <div class="text-secondary mb-3">{{ wish.receiver_name }}</div>
                            
                            <div class="d-flex gap-2 align-items-center">
                                <span class="badge bg-primary-subtle text-primary border border-primary-subtle px-2">
                                    {{ wish.wish_type|title }}
                                </span>
                                <span class="small text-muted" style="font-size: 0.75rem;">
                                    <i class="far fa-calendar-alt me-1"></i> {{ wish.created_at|date:"M d" }}
                                </span>
                            </div>
                        </div>
                        <div class="col-3 text-end d-flex flex-column justify-content-center">
                            <button class="btn btn-light text-danger rounded-circle p-2 shadow-sm ms-auto" 
                                    onclick="confirmDeleteWish('{{ wish.id }}', '{{ wish.sender_name }}')"
                                    style="width: 40px; height: 40px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5">
                    <p class="text-muted mb-0">No wishes found.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% if wishes.has_other_pages %}
    <nav class="mt-4 mb-5">
        <ul class="pagination pagination-sm justify-content-center gap-1">
            {% if wishes.has_previous %}
            <li class="page-item"><a class="page-link rounded border-0 shadow-sm text-dark" href="?page={{ wishes.previous_page_number }}&q={{ query }}&type={{ wish_type }}"><i class="fas fa-chevron-left"></i></a></li>
            {% endif %}
            <li class="page-item active"><span class="page-link rounded border-0 bg-dark shadow px-3">{{ wishes.number }}</span></li>
            {% if wishes.has_next %}
            <li class="page-item"><a class="page-link rounded border-0 shadow-sm text-dark" href="?page={{ wishes.next_page_number }}&q={{ query }}&type={{ wish_type }}"><i class="fas fa-chevron-right"></i></a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<div class="modal fade" id="deleteWishModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 320px;">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-body text-center p-4">
                <i class="fas fa-trash-alt fa-3x text-danger opacity-75 mb-3"></i>
                <h5 class="fw-bold mb-2">Delete Wish?</h5>
                <p class="text-muted small">Wish from <strong id="sender_display" class="text-dark"></strong> will be gone forever.</p>
                <div class="d-grid gap-2 mt-4">
                    <a id="delete_link" href="#" class="btn btn-danger py-2 fw-bold shadow-sm">Delete Permanently</a>
                    <button type="button" class="btn btn-light py-2 text-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Styling for the Mobile Cards */
    .d-md-none .border-bottom:last-child { border-bottom: none !important; }
    .page-link:hover { background: #f8f9fa; }
</style>

<script>
function confirmDeleteWish(id, sender) {
    const url = `/backend/wishes/delete/${id}/`;
    document.getElementById('sender_display').innerText = sender;
    document.getElementById('delete_link').setAttribute('href', url);
    new bootstrap.Modal(document.getElementById('deleteWishModal')).show();
}
</script>
{% endblock %}